// Expromptum JavaScript Library
// Copyright Art. Lebedev | http://www.artlebedev.ru/
// Updated 2014-03-18 Vladimir Tokmakov <vlalek>

(function(q){if(q.expromptum){return}q.expromptum=(function(l){var m=function(a,b){if(!a){a='[data-xp], [data-expromptum]';for(var i=0,ii=n.length;i<ii;i++){a+=','+m.controls[n[i]].prototype.element_selector}}if($.type(a)==='string'||a&&(a.nodeType||a[0]&&a[0].nodeType)){a=$(a,b?(b instanceof m.controls._item?b.$container:b):null)}if(a instanceof jQuery){return m.controls.init(a)}else if(a instanceof Object&&b){return m.controls.create(a,b)}else{if(m.debug()){console.log('Error','Unknown params',a)}return new m.list()}};m.register=function(a){var b=a.prototype||{},expromptum=b.init?function(){this._={};b.init.apply(this,arguments)}:null,base=a.base;b.toString=function(){return a.name};if(base){if(!expromptum){expromptum=base.prototype.init?function(){this._={};base.prototype.init.apply(this,arguments)}:function(){this._={}}}var f=function(){};f.prototype=base.prototype;expromptum.prototype=new f();expromptum.prototype.constructor=expromptum;expromptum.base=base.prototype}else if(!expromptum){expromptum=function(){}}$.extend(expromptum.prototype,b);return expromptum};m.list=function(b){var c=$.type(b)==='array'?b:(b?[b]:[]);c.append=function(a){if(!a){return this}if($.type(a)==='array'){for(var i=0,ii=a.length;i<ii;i++){this.append(a[i])}return this}if(this.index(a)===-1){this.push(a)}return this};c.remove=function(a){if($.type(a)==='array'){var i=a.length;while(i--){this.remove(a[i])}return this}var i=this.index(a);if(i>-1){this.splice(i,1)}return this};c.each=function(a){var i=0,ii=this.length,current,c;while(i<ii){current=this[i];c=a.apply(current,[i]);if(c===false){break}if(this[i]===current){i++}else{ii=this.length}}return this};c.first=function(a){return this.eq(0,a)};c.last=function(a){return this.eq(this.length-1,a)};c.eq=function(i,a){if(!this.length){return null}if(a){a.apply(this[i%this.length])}return this[i%this.length]};c.index=function(a){var i=this.length;while(i--){if(a===this[i]){return i}}return-1};return c};m.debug=function(a){return location.href.indexOf('xp='+(a?a:''))>0};m.after=function(a,i){if(i){return setTimeout(function(){m.after(a,--i)},0)}else{return setTimeout(function(){a()},0)}};m.taint_regexp=function(a){return a.replace(m.taint_regexp_pattern,'\\')};m.taint_regexp_pattern=/(?=[\\\^\$\.\[\]\|\(\)\?\*\+\{\}])/g;m.taint_css=function(a){return a.replace(m.taint_css_pattern,'\\')};m.taint_css_pattern=/(?=[\\\^\$\.\[\]\|\(\)\?\*\+\{\}\:\<\>\@\/\~\&\=])/g;m.locale={init:function(){var t=m.locale.number;$.extend(t,{format:{decimal:/\./,grouping:/(\d)(?=(\d{3})+([^\d]|$))/g},unformat:{decimal:new RegExp('[\\.\\'+t.decimal+']'),grouping:new RegExp('\\'+t.grouping,'g')}})},destroy:function(){},abbr:'ru',number:{decimal:',',grouping:' '},date:'dd.mm.yy',month:[{abbr:'янв',name:'Январь',name_genitive:'января'},{abbr:'фев',name:'Февраль',name_genitive:'февраля'},{abbr:'мар',name:'Март',name_genitive:'марта'},{abbr:'апр',name:'Апрель',name_genitive:'апреля'},{abbr:'мая',name:'Май',name_genitive:'мая'},{abbr:'июн',name:'Июнь',name_genitive:'июня'},{abbr:'июл',name:'Июль',name_genitive:'июля'},{abbr:'авг',name:'Август',name_genitive:'августа'},{abbr:'сен',name:'Сентябрь',name_genitive:'сентября'},{abbr:'окт',name:'Октябрь',name_genitive:'октября'},{abbr:'ноя',name:'Ноябрь',name_genitive:'ноября'},{abbr:'дек',name:'Декабрь',name_genitive:'декабря'}],first_day:1,weekday:[{abbr:'Пн',name:'Понедельник'},{abbr:'Вт',name:'Вторник'},{abbr:'Ср',name:'Среда'},{abbr:'Чт',name:'Четверг'},{abbr:'Пт',name:'Пятница'},{abbr:'Сб',name:'Суббота'},{abbr:'Вс',name:'Воскресенье'}],prev_month:'Предыдущий',next_month:'Следующий',yesterday:'Вчера',today:'Сегодня',tomorrow:'Завтра'};m.locale.init();m.base=m.register({name:'xp.base',prototype:{init:function(a){this._.on_destroy=new m.list();this._.on_change=new m.list();$.extend(this,a)},destroy:function(a,b){if(!arguments.length){var c=this;this._.on_destroy.each(function(){this.call(c)})}else{if(b){this._.on_destroy.remove(a)}else{this._.on_destroy.append(a)}}return this},change:function(a,b){if(!arguments.length){if(!this._.change_inquiry){var c=this;c._.change_inquiry=m.after(function(){c._.change_inquiry=null;c._.on_change.each(function(){this.call(c)})})}}else{if(b){this._.on_change.remove(a)}else{this._.on_change.append(a)}}return this},param:function(a,b){if(arguments.length===2){this[a]=b}return this[a]},_param:function(a,b){if(arguments.length===2){this._[a]=b}return this._[a]}}});var n=[];m.controls={register:function(a){var b=a.name;if(!a.prototype){a.prototype={}}a.prototype.type=b;this[a.name]=m.register($.extend(a,{name:'expromptum.controls.'+b,base:$.type(a.base)==='string'?this[a.base]:a.base}));if(a.prototype&&a.prototype.element_selector){n.push(b)}},init:function(c){var d=new m.list(),that=this;c.each(function(){var a=$(this),control=that.link(a);if(!control){var b=a.data('expromptum')||a.data('xp');if($.type(b)==='string'){if(!b.match(/^^\s*\{/)){b='{'+b+'}'}b=eval('(function(){return '+b.replace(/([\{,])\s*do\s*:/g,'$1\'do\':')+'})()')}a.removeAttr('data-expromptum').removeAttr('data-xp');if(!b){b={}}if(!b.type){var i=n.length;while(i--){if(a.is(m.controls[n[i]].prototype.element_selector)){b.type=n[i];break}}}if(m.controls[b.type]&&m.controls[b.type].base){b.$element=a;control=new m.controls[b.type](b)}}if(control){d.append(control)}});return d},link:function(a,b){if(b){a.data('expromptum.control',b);a[0].expromptum=b}else{return a.data('expromptum.control')}}};m.controls.register({name:'_item',base:m.base,prototype:{init:function(b){m.controls._item.base.init.apply(this,arguments);if(!this.$element){this.create()}if(m.debug('controls')){console.log('init',this.$element,this)}if(!this.$container&&this.container_selector){this.$container=this.$element.parents(this.container_selector).first()}if(!this.$container||!this.$container.length){this.$container=this.$element}var a=['disabled','required','autofocus','min','max','step'],i=a.length,v;while(i--){v=this.$element.attr(a[i]);if(v!==l&&!this[a[i]]!==l){this[a[i]]=v}}if(this.autofocus){this.$element.focus()}var c=this;this._init_val();if(this.disabled||this.enabled===false){this.disabled=false;m.after(function(){c.disable()})}m.after(function(){c.change();c._init_val()});if(!this._.parent){this.$element.parentsUntil('body').each(function(){var a=m.controls.link($(this));if(a){c._.parent=a;return false}})}if(this._.parent){this._.no_root_dependencies=this._.parent._.no_root_dependencies;this._.parent._.children.append(this);this._.root=this._.parent._.root}else{this._.root=this}m.controls.link(this.$element,this);m.controls.link(this.$container,this);if(m.repeats){m.repeats.init(this)}m.dependencies.init(this)},remove:function(){var b=this.$container,destroy_with_children=function(a){if(a.children){a.children().each(function(){destroy_with_children(this)})}a.destroy()};destroy_with_children(this);b.remove()},destroy:function(a,b){m.controls._item.base.destroy.apply(this,arguments);if(!arguments.length){if(this._.parent){this._.parent._.children.remove(this)}this.$container=this.$element=this._=null}return this},parent:function(){return this._.parent},root:function(){return this._.root},_init_val:function(){this._.initial_value=this._.value=this.val()},val:function(a){if(!arguments.length){return''}else{this.change();return this}},disable:function(a){a=!arguments.length||a;if(this.disabled!==a){if(a){this.$element.add(this.$container.addClass(this.container_disabled_class)).attr('disabled',true)}else{var b=this;while((b=b.parent())&&b!=this){if(b.disabled){return this}}this.$element.add(this.$container.removeClass(this.container_disabled_class)).removeAttr('disabled')}this.disabled=a;this.change()}return this},container_disabled_class:'disabled',_get_html:function(){return this.html}}});m.controls.register({name:'html',base:'_item',prototype:{element_selector:'.xp_html',val:function(a){if(!arguments.length){return this.disabled?l:this.$element.html()}else{this.$element.html(a);this.change();return this}}}});m.controls.register({name:'_parent',base:'_item',prototype:{element_selector:'.xp',init:function(a){this.changed={};this._.children=new m.list();m.controls._parent.base.init.apply(this,arguments);this._.children_values={};var b=this._.parent||this._.root;while(!b.name&&!b.repeat&&b._.parent){b=b._.parent}this._.parent4values=b},children:function(){return this._.children},destroy:function(a,b){if(!arguments.length){this._.parent4values._unsave_val(this)}return m.controls._parent.base.destroy.apply(this,arguments)},disable:function(a){if(this.disabled!==a){m.controls._parent.base.disable.apply(this,arguments);if(this.disabled){this._.parent4values._unsave_val(this)}this._.children.each(function(){this.disable(a)})}return this},val:function(a,b){if(!arguments.length){return this._.children_values}else{var c=this;if(this.repeat){if($.type(a)!=='array'){a=[a]}for(var i=0,ii=a.length,j,suffix;i<ii;i++){if(i){c=c.repeat.append(c)}c._set_vals(a[i],b+c.repeat.name_suffix_before+i+c.repeat.name_suffix_after)}}else{c._set_vals(a,'')}return this}},_set_vals:function(d,e){var f=this;m.after(function(){$.each(d,function(a,b){var c=f._find_by_name(a)||f._find_by_name(a+e);if(c){for(var i=0,ii=c.length;i<ii;i++){c[i].val(b,e)}}})},4)},change:function(a,b){if(!arguments.length&&this._.parent4values){this._.parent4values._save_val(this)}return m.controls._parent.base.change.apply(this,arguments)},_save_val:function(b){if(b.name){if(b.repeat){var c=this._.children_values[b.name];if($.type(c)!=='array'){c=this._.children_values[b.name]=[]}if(!b._.repeat_template){c[b._.repeat_position]=b.val()}}else{var d=this.repeat?b.name.split(this.repeat.name_suffix_splitter)[0]:b.name;if(b instanceof m.controls.checkbox){this._.children_values[d]=c=[];if(!b._.group){return}b._.group.siblings.each(function(){var a=this.val();if(a!==''){c.push(a)}})}else{this._.children_values[d]=b.val()}}}},_unsave_val:function(a){if(a.name){if(a.repeat){var b=this._.children_values[a.name];if(!a._.repeat_template){b.splice(a._.repeat_position,1)}}else{var c=this.repeat?a.name.split(this.repeat.name_suffix_splitter)[0]:a.name;delete this._.children_values[c]}}},_find_by_name:function(a){var b=[],subresult;this.children().each(function(){if(this.name==a){subresult=[this]}else if(this._find_by_name){subresult=this._find_by_name(a)}else{subresult=null}if(subresult){b=b.concat(subresult);if(!(subresult[0]instanceof m.controls._option)){return false}}});return b.length?b:null}}});m.controls.register({name:'form',base:'_parent',prototype:{element_selector:'form',init:function(b){this.uncomplete_if_required=true;this.uncomplete_if_invalid_required=true;m.controls.form.base.init.apply(this,arguments);this._.onsubmit=new m.list();var c=this;this.$element.bind('submit',function(){return c.submit()});this.submit(function(){var a=this.uncompleted();if(a){if(m.debug('submit')){console.log(a)}return false}else if(this.locked){if(m.debug('submit')){console.log('locked')}return false}else{this.locked=true}if(m.debug('submit')){console.log('submit');return false}})},submit:function(a,b){if(!arguments.length){var c=this,result=true;this._.onsubmit.each(function(){if(!this.call(c)){result=false}});return result}else{if(b){this._.onsubmit.remove(a)}else{this._.onsubmit.append(a)}return this}},uncompleted:function(){if(this.uncomplete_if_required&&this._.required&&$.grep(this._.required,function(a){return!a.disabled}).length){return'required'}if(this.uncomplete_if_invalid_required&&this._.invalid&&$.grep(this._.invalid,function(a){return!a.disabled&&a.required}).length){return'invalid_required'}if(this.uncomplete_if_invalid&&this._.invalid&&$.grep(this._.invalid,function(a){return!a.disabled}).length){return'invalid'}if(this.uncomplete_if_unchanged&&!(this._.changed&&$.grep(this._.changed,function(a){return!a.disabled}).length)){return'unchanged'}return null}}});m.controls.register({name:'fields',base:'_parent',prototype:{element_selector:'fieldset, .fields, .sheets',count:function(){if(this.disabled||!this.children().length){return l}var a=0;this.children().each(function(){if(this instanceof m.controls.fields){if(this.val()){a++}}else if(this.val()!=''){a++}});return a}}});m.controls.register({name:'sheet',base:'fields',prototype:{element_selector:'.sheet',init:function(b){m.controls.sheet.base.init.apply(this,arguments);var c=this.$element.attr('id');if(!this.$label&&c){this.$label=$("[for='"+m.taint_css(c)+"']")}if(this.$label&&this.$label[0]){var d=this.parent(),that=this;this.select(!d._param('selected_sheet')||this.selected||this.$label.hasClass(this.selected_class));this.$label.click(function(){var a=d._param('selected_sheet');if(a&&a!==that){a.select(false)}that.select()})}},select:function(a){if(!arguments.length||a){var b=this.parent(),previous=b._param('selected_sheet');if(previous!==this){if(previous){previous.select(false)}b._param('selected_sheet',this);this.$container.add(this.$label).removeClass(this.unselected_class).addClass(this.selected_class)}}else{this.$container.add(this.$label).removeClass(this.selected_class).addClass(this.unselected_class)}return this},selected_class:'selected',unselected_class:'unselected'}});m.controls.register({name:'_field',base:'_parent',prototype:{element_selector:'input',container_selector:'.field',init:function(b){m.controls._field.base.init.apply(this,arguments);var c=this;this.$element.bind(this.change_events,function(){c.change()});this.$element.blur(function(){c.$container.addClass(c.container_blured_class)});this.name=this.$element.attr('name');var d=this.$element.attr('id');if(!this.$label&&d){this.$label=$("[for='"+m.taint_css(d)+"']")}if(this.$container==this.$element){this.$container=this.$container.add(this.$label)}if(this.allow_chars_pattern){this.$element.keypress(function(a){if(a.charCode&&!(a.metaKey||a.ctrlKey||a.altKey)&&!String.fromCharCode(a.charCode).match(c.allow_chars_pattern)){return false}})}m.controls._field.base.change.apply(this)},change_events:'keyup change',container_blured_class:'blured',destroy:function(a,b){if(!arguments.length){this.$label=null}return m.controls._field.base.destroy.apply(this,arguments)},change:function(a,b){if(!arguments.length){var c=this,changed=false,old=this._param('value'),cur=this.val();if(old!=cur){changed=true;this._param('value',cur)}if(changed){return m.controls._field.base.change.apply(this,arguments)}else{return this}}else{return m.controls._field.base.change.apply(this,arguments)}},val:function(a){if(!arguments.length){return this.disabled?l:this.$element.val()}else{var b=this.$element[0],start=b.selectionStart,end=b.selectionEnd;if(b.value!=a){b.value=a;if(this.$element.is(':focus')){b.selectionStart=start;b.selectionEnd=end}this.change()}return this}}}});m.controls.register({name:'string',base:'_field',prototype:{element_selector:'input[type=text], input:not([type])'}});m.controls.register({name:'text',base:'_field',prototype:{element_selector:'textarea'}});m.controls.register({name:'hidden',base:'_field',prototype:{element_selector:'input[type=hidden]'}});m.controls.register({name:'file',base:'_field',prototype:{element_selector:'input[type=file]'}});m.controls.register({name:'button',base:'_parent',prototype:{element_selector:'input[type=button], button, .button'}});m.controls.register({name:'submit',base:'_item',prototype:{element_selector:'input[type=submit], button[type=submit]'}});m.controls.register({name:'select',base:'_field',prototype:{element_selector:'select',hide_disabled_option:true,init:function(a){m.controls.select.base.init.apply(this,arguments);this._.options=this.$element[0].options;this._.all_options=[];var b=this.$element[0].options,i=0,ii=b.length;for(;i<ii;i++){this._.all_options[i]=b[i]}},disable:function(a,b){if(b!==l){if($.type(b)!=='array'){b=[b]}var i=0,ii=this._.all_options.length,option,j,jj=b.length,disable,k=0,value=this.val(),options=this._.options,selected;if(this.hide_disabled_option){options.length=0}if(a){this._.disabled_value=value}else{var c=this;m.after(function(){c._.disabled_value=l})}for(;i<ii;i++){disable=true;option=this._.all_options[i];if(!this.hide_disabled_option){k=i}if(!a){for(j=0;j<jj;j++){if($.type(b[j])==='regexp'){disable=!option.value.match(b[j])}else{disable=option.value!=b[j]}if(!disable){if(selected===l||value==option.value||(value===null&&this._.disabled_value==option.value)){selected=k}option.disabled='';if(this.hide_disabled_option&&!option.parentNode){options[options.length]=option;k++}break}}}if(disable){option.disabled='true'}}if(selected!==l&&this._.options[selected].value!=value){this.$element[0].selectedIndex=selected;this.$element.change()}return this}else{return m.controls.select.base.disable.apply(this,arguments)}}}});m.controls.register({name:'options',base:'fields',prototype:{element_selector:'.options'}});m.controls.register({name:'_option',base:'_field',prototype:{container_selector:'.option',init:function(a){m.controls._option.base.init.apply(this,arguments);if(!this.root()._param(this.type)){this.root()._param(this.type,{})}if(!this.root()._param(this.type)[this.name]){this.root()._param(this.type)[this.name]={siblings:new m.list()}}this._.group=this.root()._param(this.type)[this.name];this._.group.siblings.append(this);this.selected=null;this._init_val()},change_events:'change',change:function(a,b){this.select(this.$element.is(':checked'),true);m.controls._option.base.change.apply(this,arguments);return this},_init_val:function(){if(this.selected){this.$container.addClass(this.container_initial_selected_class)}m.controls._option.base._init_val.apply(this,arguments)},container_initial_selected_class:'initial_selected',container_selected_class:'selected',val:function(a){if(!arguments.length){return!this.selected?'':m.controls._option.base.val.apply(this,arguments)}else if($.type(a)==='array'){var i=a.length;while(i--){if(this.$element[0].value==a[i]){break}}this.select(i>-1)}else{this.select(this.$element[0].value==a)}return this},select:function(a,b){a=!arguments.length||a;if(this.selected!==a){this.selected=a;this.$container.toggleClass(this.container_selected_class,a);if(a){this.$element.attr('checked',true);this.$element[0].checked=true}else{this.$element.removeAttr('checked')}if(!b){this.change()}}return this}}});m.controls.register({name:'radio',base:'_option',prototype:{element_selector:'input[type=radio]',disable:function(a){if(this.disabled!==a){m.controls.radio.base.disable.apply(this,arguments);if(a){if(this.selected){this._.group.siblings.each(function(){if(!this.disabled){this.select();return false}})}}else if(this._.group.selected&&this._.group.selected.disabled){this.select();this.change()}}return this},select:function(a,b){a=!arguments.length||a;if(this.selected!==a){if(a&&this._.group){var c=this._.group.selected;this._.group.selected=this;if(c){c.select(false)}}m.controls.radio.base.select.apply(this,arguments)}return this}}});m.controls.register({name:'checkbox',base:'_option',prototype:{element_selector:'input[type=checkbox]'}});m.controls.register({name:'email',base:'_field',prototype:{element_selector:'.email input, input.email',valid:'[this].val().match(/^\\S+@\\S+\\.\\S{2,4}$/)'}});m.controls.register({name:'phone',base:'_field',prototype:{element_selector:'.phone input, input.phone',valid:'[this].val().match(/^(?=[^()]*\\(([^()]*\\)[^()]*)?$|[^()]*$)(?=[\\s(]*\\+[^+]*$|[^+]*$)([-+.\\s()]*\\d){11,18}$/)'}});m.controls.register({name:'_secret',base:'string',prototype:{init:function(a){m.controls._secret.base.init.apply(this,arguments);this.$secret=$($('<div>').append(this.$element.clone().hide()).html().replace(/\s+(type|id)\s*=\s*[^\s>]+/g,'')).insertBefore(this.$element);this.$element.removeAttr('name');m.controls.link(this.$secret,this)},destroy:function(a,b){if(!arguments.length){this.$secret=null}return m.controls._secret.base.destroy.apply(this,arguments)},disable:function(a){if(this.disabled!==a){if(a){this.$secret.attr('disabled',true)}else{this.$secret.removeAttr('disabled')}m.controls._secret.base.disable.apply(this,arguments)}return this}}});m.controls.register({name:'password',base:'_secret',prototype:{element_selector:'input[type=password]',init:function(a){m.controls.password.base.init.apply(this,arguments);var b=this;this.$element.bind('keyup change',function(){b.$secret.val(b.$element.val())});this.$secret.bind('keyup',function(){b.$element.val(b.$secret.val())});this.control_button_view=$(this.control_button_view_html).insertAfter(this.$element).click(function(){if(b.disabled){return false}b.$container.toggleClass(b.container_view_class);b.control_button_view.toggleClass(b.control_button_view_class);b.$element.toggle();b.$secret.toggle();(b.$secret.is(':visible')?b.$secret:b.$element).focus()[0].selectionStart=1000})},container_view_class:'alt',control_button_view_class:'control_button_password_view',control_button_view_html:'<span class="control_button control_button_password"/>'}});m.controls.register({name:'number',base:'_secret',prototype:{element_selector:'input.number, .number input',step:1,min:1-Number.MAX_VALUE,def:0,max:Number.MAX_VALUE-1,locale:m.locale,init:function(b){this.allow_chars_pattern=new RegExp('^[-0-9\\s'+this.locale.number.decimal+this.locale.number.grouping+']$');m.controls.number.base.init.apply(this,arguments);var c=this;this.$element.wrap(this.element_wrap_html);$(this.control_button_dec_html).insertBefore(this.$element).mousedown(function(){if(c.disabled){return false}c.dec();return false});$(this.control_button_inc_html).insertAfter(this.$element).mousedown(function(){if(c.disabled){return false}c.inc();return false});this.$element.val(this._format(this.$element.val())).keydown(function(a){if(a.which===38){c.inc();return false}else if(a.which===40){c.dec();return false}});this.change(function(){this.$secret.val(c.val())});this.$element.blur(function(){c.val(c.val())})},destroy:function(a,b){if(!arguments.length){}return m.controls.number.base.destroy.apply(this,arguments)},element_wrap_html:'<span class="number_control"/>',control_button_dec_html:'<span class="control_button control_button_dec"/>',control_button_inc_html:'<span class="control_button control_button_inc"/>',inc:function(){var a=this.val();if(!a&&a!==0){a=this.def}a=a-0+this.step*1;if(a>this.max*1){return false}return this.val(a)},dec:function(){var a=this.val();if(!a&&a!==0){a=this.def}a=a-this.step*1;if(a<this.min*1){return false}return this.val(a)},val:function(a){if(!arguments.length){return this.disabled?l:this._unformat(this.$element.val())}else{this.$secret.val(this._unformat(a));return m.controls.number.base.val.apply(this,[this._format(a)])}},_format:function(a){var b=this.locale.number;a+='';return a.replace(b.format.decimal,b.decimal).replace(b.format.grouping,'$1'+b.grouping)},_unformat:function(a){var b=this.locale.number;a+='';return a.replace(b.unformat.grouping,'').replace(b.unformat.decimal,'.')}}});m.controls.register({name:'date',base:'_secret',prototype:{element_selector:'input.date, .date input',init:function(a){this.locale=m.locale;m.controls.date.base.init.apply(this,arguments);var b=[],day_names=[this.locale.weekday[6].name],day_names_min=[this.locale.weekday[6].abbr];for(var i=0,ii=this.locale.month.length;i<ii;i++){b.push(this.locale.month[i].name)}for(var i=0,ii=this.locale.weekday.length-1;i<ii;i++){day_names.push(this.locale.weekday[i].name);day_names_min.push(this.locale.weekday[i].abbr)}this.$element.datepicker($.extend({autoSize:true,changeMonth:true,changeYear:true,dateFormat:this.locale.date,firstDay:this.locale.first_day,prevText:this.locale.prev_month,nextText:this.locale.next_month,dayNames:day_names,dayNamesMin:day_names_min,monthNamesShort:b,altField:this.$secret,altFormat:'yy-mm-dd'},this.datepicker));if(this._.initial_value){this.$element.datepicker('setDate',new Date(this._.initial_value.replace(/\s*\d+:\S+\s*/,'')))}},destroy:function(a,b){if(!arguments.length){this.locale.destroy();this.$element.datepicker('destroy')}return m.controls.date.base.destroy.apply(this,arguments)},param:function(a,b){switch(a){case'min':this.$element.datepicker('option','minDate',b);return b;break;default:return m.controls.date.base.param.apply(this,arguments)}},date:function(){return this.$element.datepicker('getDate')},val:function(a){if(!arguments.length){return this.disabled?l:(this.$secret?this.$secret.val():this.$element.val())}else{this.$element.datepicker('setDate',new Date(a));return this}}}});m.controls.register({name:'datetime',base:'date',prototype:{element_selector:'input.datetime, .datetime input',init:function(a){var b=a.$element.val();m.controls.datetime.base.init.apply(this,arguments);this._.$time=$('<input value="'+b.substr(11,2)+'" class="hours"/>:<input value="'+b.substr(14,2)+'" class="minutes"/>').insertAfter(this.$element);var c=this,add_time=function(){c.$secret.val(c.$secret.val().replace(/\s+\d+:\d+/,'')+' '+c._.$time.first().val()+':'+c._.$time.last().val())};this._.time_control=new m.list();this._.$time.filter('input').each(function(){c._.time_control.append((new m.controls.number({$element:$(this),min:0,max:23,changed:null})).change(add_time).change(function(){c.change()}))});this._.time_control.last().max=59;this.change(add_time);if(this._.initial_value){this.$secret.val(this._.initial_value)}},destroy:function(a,b){if(!arguments.length){this._.time_control.each(function(){this.destroy()});this._.$time.remove()}return m.controls.datetime.base.destroy.apply(this,arguments)},disable:function(a){if(this.disabled!==a){m.controls.datetime.base.disable.apply(this,arguments);this._.time_control.each(function(){this.disable(a)})}return this}}});m.controls.register({name:'combobox',base:'string',prototype:{element_selector:'.combobox input, input.combobox, input[list]',search_from_start:true,init:function(d){m.controls.combobox.base.init.apply(this,arguments);var e=$("select#"+m.taint_css(this.$element.attr('list')));if(e[0]){var f=new m.controls._combolist({$element:e,$container:e}),that=this;that.list=f;this.change(function(){var a=this.val();if(a!=''){var b=f._param('options').length;f.disable(false,new RegExp((this.search_from_start?'^':'')+m.taint_css(a)));var c=f._param('options').length;if(c===0){f.hide()}}else{f.disable(false,/.?/)}f.$element[0].selectedIndex=8888});this.$element.bind('focus click',function(){f.show()}).keydown(function(a){if(a.keyCode===38||a.keyCode===40){f._param('do_not_hide',true);f.show();f.$element.focus()}}).blur(function(){if(!f._param('do_not_hide')){f.hide()}});f.$element.mousedown(function(a){f._param('do_not_hide',true)}).bind('keydown click',function(a){if(a.type==='click'||a.keyCode===13){that.val(f.val());that.$element.focus();f.hide()}}).bind('blur keypress',function(a){if(a.type==='blur'||a.keyCode===27){that.$element.focus();f.hide()}})}}}});m.controls.register({name:'_combolist',base:'select',prototype:{init:function(a){m.controls._combolist.base.init.apply(this,arguments);this.$element.css({'position':'absolute','z-index':888});this.$element.attr('size',7);this.hide()},show:function(){if(this.$element[0].options.length){this.$element.show()}return this},hide:function(){this._param('do_not_hide',false);this.$element.hide();return this}}});var o=[];m.dependencies={_controls:{},_functions:[],register:function(a){var b=a.name;if(!a.prototype){a.prototype={}}a.prototype.type=b;this[a.name]=m.register($.extend(a,{name:'expromptum.dependencies.'+b,base:$.type(a.base)==='string'?this[a.base]:a.base}));o.push(b)},init:function(a,b){var c=this;m.after(function(){if(!b&&a instanceof m.controls._item){b=a}var i=0,ii=o.length,param;for(;i<ii;i++){param=a[o[i]];if(param&&!(param instanceof m.dependencies._item)){if($.type(param)==='array'){for(var j=0,jj=param.length;j<jj;j++){new c[o[i]](param[j],b)}}else{new c[o[i]](param,b)}}}})}};m.dependencies.register({name:'_item',base:m.base,prototype:{init:function(c,d){this.to=d;if($.type(c)==='string'){c={on:c}}m.dependencies._item.base.init.apply(this,arguments);var e=this;var f=function(a){if($.type(a)!=='array'){a=[a]}var b=new m.list();for(var i=0,ii=a.length;i<ii;i++){if($.type(a[i])==='string'){b.append(m(a[i]))}else{b.append(a[i])}}return b};this.to=f(this.to);this.from=f(this.from);if($.type(this.on)==='string'){this.on=this.on.replace(/((?:\[(?:[^\[\]]+=(?:[^\[\]]|\[[^\[\]]*\])+|this|self)\])+)(\.?)/g,function(){var a;if(arguments[1]==='[this]'||arguments[1]==='[self]'){a=e.to}else{a=m(arguments[1])}e.from.append(a);id=e.from.index(a[0]);return'arguments["'+id+'"].'+(arguments[2]=='.'?'':(a[0]instanceof m.controls.fields?'count':'val')+'()')});eval('this.on = function(){return '+this.on+'}')}if(!this.from.length){this.from.push(d)}var g=function(){e.destroy()};this.suprocess=function(){e.process()};this.from.each(function(){this.change(e.suprocess);this.destroy(g)});this.to.each(function(){if(this[e.type]instanceof m.dependencies._item){}this[e.type]=e;this.destroy(g)});if(d&&!(d[this.type]instanceof m.dependencies._item)){d[this.type]=null}this.init_process();if(m.debug('dependencies')){console.log('init',this.to.first().$element,this)}},init_process:function(){m.after(this.suprocess,0)},destroy:function(){var a=this;if(this.from){this.from.each(function(){this.change(a.suprocess,true)})}if(this.to){this.to.each(function(){this[a.type]=null})}this.from=this.to=this.on=this['do']=null;return this},process:function(){this.result=this.on.apply(this,this.from)}}});m.dependencies.register({name:'classed',base:'_item',prototype:{process:function(){if(m.debug('dependencies')||m.debug('classed')){console.log('classed',this.to.first().$element,this.to)}m.dependencies.classed.base.process.apply(this);var a=this;this.to.each(function(){if(a.result){this.$container.addClass(a['do'])}else{this.$container.removeClass(a['do'])}})}}});m.dependencies.register({name:'computed',base:'_item',prototype:{process:function(){if(m.debug('dependencies')||m.debug('computed')){console.log('computed',this.to.first().$element,this.to)}m.dependencies.classed.base.process.apply(this);var a=this;this.to.each(function(){if(a['do']){this.param(a['do'],a.result)}else{this.val(a.result)}})}}});m.dependencies.register({name:'enabled',base:'_item',prototype:{init_process:function(){this.suprocess();this.to.each(function(){})},process:function(){m.dependencies.enabled.base.process.apply(this);var b=function(a){a.each(function(){if(this.enabled&&this.enabled.process){this.enabled.process()}if(this.children){b(this.children())}})};var c=this,enable;this.to.each(function(){if(c.values){if(c.result){enable=this;m.after(function(){enable.disable(false,c.values)})}else{this.disable(true,'')}}else{this.disable(!c.result);if(c.result&&this.children){b(this.children())}}});if(m.debug('dependencies')||m.debug('enabled')){console.log('enabled',this.to.first().$element,this.to,this.result)}}}});m.dependencies.register({name:'enabled_on_completed',base:'_item',prototype:{init:function(a,b){m.dependencies.enabled_on_completed.base.init.apply(this,[{from:[b.root()]},b])},process:function(){if(m.debug('dependencies')||m.debug('enabled_on_completed')){console.log('enabled_on_completed',this.to.first().$element,this.to)}this.result=this.to.first().root().uncompleted();var a=this;this.to.each(function(){this.disable(a.result)})}}});m.dependencies.register({name:'_rooted',base:'_item',prototype:{init:function(a,b){if(!this._.root_type){this._.root_type=this.type}m.dependencies._rooted.base.init.apply(this,arguments);var c=this.to.first().root();this._.root=c._param(this._.root_type)||c._param(this._.root_type,new m.list())},destroy:function(){if(this.to){this.to_root(false);this.to.first().root().change()}return m.dependencies._rooted.base.destroy.apply(this,arguments)},to_root:function(a){var b=this;this.to.each(function(){if(this._.no_root_dependencies){return}if(a){b._.root.append(this)}else{b._.root.remove(this)}})}}});m.dependencies.register({name:'required',base:'_rooted',prototype:{init:function(a,b){if($.type(a)==='string'){a={on:a}}if($.type(a.on)==='string'&&!a.on.match(/\[(?:this|self)\]/)){a.on="![this] || !("+a.on+")"}if(!a.on){this.on="![this]"}m.dependencies.required.base.init.apply(this,[a,b])},process:function(){if(m.debug('dependencies')||m.debug('required')){console.log('required',this.to.first().$element,this.to)}m.dependencies.required.base.process.apply(this);var a=this;this.to.each(function(){if(a.result){this.$container.addClass(a.container_required_class).removeClass(a.container_unrequired_class)}else{this.$container.removeClass(a.container_required_class).addClass(a.container_unrequired_class)}});this.to_root(this.result)},container_required_class:'required',container_unrequired_class:'unrequired'}});m.dependencies.register({name:'valid',base:'_rooted',prototype:{init:function(a,b){this._.root_type='invalid';m.dependencies.valid.base.init.apply(this,arguments)},process:function(){if(m.debug('dependencies')||m.debug('valid')){console.log('valid',this.result,this.to.first().$element,this.to)}var a=this;this.to.each(function(){if(!this.val()&&!(this instanceof m.controls.fields)){this.$container.removeClass(a.container_valid_class).removeClass(a.container_invalid_class);a.result=true}else{m.dependencies.valid.base.process.apply(a);if(a.result){this.$container.addClass(a.container_valid_class).removeClass(a.container_invalid_class)}else{this.$container.removeClass(a.container_valid_class).addClass(a.container_invalid_class)}}});this.to_root(!this.result)},container_valid_class:'valid',container_invalid_class:'invalid'}});m.dependencies.register({name:'changed',base:'_rooted',prototype:{init:function(a,b){m.dependencies.changed.base.init.apply(this,arguments);var c=this;m.after(function(){},1)},process:function(){if(m.debug('dependencies')||m.debug('changed')){console.log('changed',this.to.first().$element,this.to)}var c=this;this.to.each(function(){var a=this.val(),ini=this._param('initial_value');c.result=(ini===l?'':ini)!=a;this.$container.toggleClass(c.container_changed_class,c.result);c.to_root(c.result);var b=this.parent();if(b){b.change()}})},change_parents:function(){var b=new m.list();this.to.each(function(){var a=this;while(a=a.parent()){b.append(a)}});b.each(function(){this.change()})},container_changed_class:'changed'}});m.controls.register({name:'repeat_append_button',base:'button',prototype:{element_selector:'.repeat_append_button',init:function(a){m.controls.repeat_append_button.base.init.apply(this,arguments);var b=this.parent(),repeat=b.repeat;if(!(repeat instanceof m.repeats.item)){return}this.$element.click(function(){repeat.append(b);return false});this.enabled={on:function(){return repeat.val()<repeat.max},from:repeat}}}});m.controls.register({name:'repeat_insert_button',base:'button',prototype:{element_selector:'.repeat_insert_button',init:function(a){m.controls.repeat_insert_button.base.init.apply(this,arguments);var b=this.parent(),repeat=b.repeat;if(!(repeat instanceof m.repeats.item)){return}this.$element.click(function(){repeat.append(b,true);return false});this.enabled={on:function(){return repeat.val()<repeat.max},from:repeat}}}});m.controls.register({name:'repeat_remove_button',base:'button',prototype:{element_selector:'.repeat_remove_button',init:function(a){m.controls.repeat_remove_button.base.init.apply(this,arguments);var b=this.parent(),repeat=b.repeat;if(!(repeat instanceof m.repeats.item)){return}this.$element.click(function(){repeat.remove(b);return false});this.enabled={on:function(){return repeat.val()>repeat.min},from:repeat}}}});m.controls.register({name:'repeat_first_button',base:'button',prototype:{element_selector:'.repeat_first_button',init:function(a){m.controls.repeat_first_button.base.init.apply(this,arguments);var b=this.parent(),repeat=b.repeat;if(!(repeat instanceof m.repeats.item)){return}this.$element.click(function(){repeat.move(b,0);return false});this.enabled={on:function(){return 0<b._param('repeat_position')*1},from:repeat}}}});m.controls.register({name:'repeat_prev_button',base:'button',prototype:{element_selector:'.repeat_prev_button',init:function(a){m.controls.repeat_first_button.base.init.apply(this,arguments);var b=this.parent(),repeat=b.repeat;if(!(repeat instanceof m.repeats.item)){return}this.$element.click(function(){repeat.move(b,b._param('repeat_position')-1);return false});this.enabled={on:function(){return 0<b._param('repeat_position')*1},from:repeat}}}});m.controls.register({name:'repeat_next_button',base:'button',prototype:{element_selector:'.repeat_next_button',init:function(a){m.controls.repeat_first_button.base.init.apply(this,arguments);var b=this.parent(),repeat=b.repeat;if(!(repeat instanceof m.repeats.item)){return}this.$element.click(function(){repeat.move(b,b._param('repeat_position')*1+1);return false});this.enabled={on:function(){return repeat.children().length-1>b._param('repeat_position')*1},from:repeat}}}});m.controls.register({name:'repeat_last_button',base:'button',prototype:{element_selector:'.repeat_last_button',init:function(a){m.controls.repeat_first_button.base.init.apply(this,arguments);var b=this.parent(),repeat=b.repeat;if(!(repeat instanceof m.repeats.item)){return}this.$element.click(function(){repeat.move(b,repeat.children().length-1);return false});this.enabled={on:function(){return repeat.children().length-1>b._param('repeat_position')*1},from:repeat}}}});m.repeats={init:function(a){if(a.repeat){if($.type(a.repeat)!=='object'){a.repeat={}}if(!a.root()._param('repeats')){a.root()._param('repeats',{})}a.repeat.id=a.repeat.id||a.name;var b=a.repeat.id,repeats=a.root()._param('repeats');if(!repeats[b]){repeats[b]=new m.repeats.item(a)}else{repeats[b].adopt(a)}}}};m.repeats.item=m.register({name:'expromptum.repeats.item',base:m.base,prototype:{min:1,max:300,name_suffix_before:'[',name_suffix_after:']',id_suffix_before:'~',id_suffix_after:'',container_inited_class:'repeated',container_position_class:'repeated_',container_template_class:'repeated_template',init:function(b){if(m.debug('repeats')){console.log('init',b.$element,b.repeat.id,this)}m.repeats.item.base.init.apply(this);this.name_suffix_splitter=new RegExp('('+m.taint_regexp(this.name_suffix_before)+'\\d+'+m.taint_regexp(this.name_suffix_after)+')(?=(?:'+m.taint_regexp(this.name_suffix_before)+'\\d+'+m.taint_regexp(this.name_suffix_after)+')*$)');this.id_suffix_pattern=new RegExp(m.taint_regexp(this.id_suffix_before)+'\\d+'+m.taint_regexp(this.id_suffix_after)+'$');this.container_position_class_pattern=new RegExp('(^|\\s)'+m.taint_regexp(this.container_position_class)+'\\d+(?=\\s|$)');this._.children=[];this.nesting=0;var c=b;while(c&&(c=c.parent())){if(c.repeat){this.parent=c;this.nesting=c.repeat.nesting+1;break}}this.adopt(b,true);var d=this;m.after(function(){if(!d.template){d.temp_template=true;var a=d.children(),b=a[a.length-1];d.append(b);d.temp_template=false}},1)},destroy:function(a,b){m.repeats.item.base.destroy.apply(this,arguments);if(!arguments.length&&this.control._){this.control.root()._param('repeats')[this.id]=null}return this},val:function(a){return this.children().length},children:function(){return this._.children},adopt:function(b,c){b._param('repeat_position',0);var d=this,template=(b.repeat.template||this.temp_template)&&!this.template;$.extend(this,b.repeat);if(!this.control||template){m.after(function(){d.control=b});b.$container.find('*:not([id])').andSelf('*:not([id])').each(function(){this.id='xp'+(Math.random()+'').substr(2,8)});if(!b.html){b.html=$('<div>').append(b.$container.clone()).html()}}m.after(function(){b.$container.find('*[id^=xp]').andSelf('*[id^=xp]').each(function(){var a=$(this),b=m.controls.link(a);if(!b||b.$element[0]!==this){a.removeAttr('id')}})});if(template){b._.repeat_template=true;b._.no_root_dependencies=true;b.$container.hide();b.$container.addClass(this.container_template_class);m.after(function(){b.$container.find('input, textarea, select, button').andSelf().attr('disabled',true)})}else{repeat_change_suffixes(this,b,this.position!==l?this.position:this.children().length);this.children().push(b)}if(this.control){repeat_new_control_count++}b.repeat=this;b.destroy(function(){var a=d.children(),i=a.length;while(i--){if(b===a[i]){d._.children.splice(i,1);break}}if(!d.children().length){d.destroy()}});b.$container.addClass(this.container_inited_class)},move:function(a,b){var c=this.children(),i,ii,old_position=a._param('repeat_position');if(b<old_position){a.$container.insertBefore(c[b].$container);i=b;ii=c.length}else{a.$container.insertAfter(c[b].$container);i=old_position;ii=b+1}c.splice(b,0,c.splice(old_position,1)[0]);for(;i<ii;i++){repeat_change_suffixes(this,c[i],i)}this.change()},remove:function(a){var b=this.children(),i=b.length,ii=i-1;while(i--){if(a===b[i]){b.splice(i,1);break}}a.remove();while(ii--&&ii>=i){repeat_change_suffixes(this,b[ii],ii)}this.change()},append:function(a,b){var d=this.children(),i=ii=d.length;while(i--){if(a===d[i]){break}}if(b){i--}while(ii--&&ii>i){repeat_change_suffixes(this,d[ii],ii+1)}var e=this.id_suffix_before+repeat_new_control_count+this.id_suffix_after,$container=$(this.control._get_html().replace(/(\s(id|for|list)\s*=\s*([\"\'])\S+)\3/g,'$1'+e+'$3'));$container.find('[data-xp]').each(function(){$(this).removeAttr('data-xp')});if(b){$container.insertBefore(a.$container)}else{$container.insertAfter(a.$container)}var f=p(this,$container,this.control,e,this.temp_template?888:i+1);if(!this.temp_template){var c=this.children().pop();this.children().splice(i+1,0,c)}this.change();return f}}},'xp.repeats.item');var p=function(a,b,c,d,e){var f='#'+m.taint_css(c.$element.attr('id').replace(a.id_suffix_pattern,'')+d),$element=b.is(f)?b:$(f,b);if(!$element[0]){if(q.console){console.warn('In',b,'not found',f,'by',c.$element.first(),'via suffix',d)}return}var g=repeat_get_params(a,b,c,d);g.$element=$element;g.changed=l;if(c.repeat){if(c.repeat.id!==a.id){g.repeat={id:c.repeat.id+d};if(c===c.repeat.control&&!a.temp_template){g.repeat.template=true}}else{c.repeat.position=e}}var h=m.controls.link(g.$element);if(!h){h=new m.controls[g.type](g)}if(c.children){c.children().each(function(){p(a,b,this,d,e)})}return h},repeat_change_suffixes=function(c,d,e){d._param('repeat_position',e);d.$container[0].className=d.$container[0].className.replace(c.container_position_class_pattern,'');if(!c.name_suffix_before){return}d._.repeat_suffix=(c.parent?c.parent._.repeat_suffix:'')+c.name_suffix_before+e+c.name_suffix_after;d.$container.addClass(c.container_position_class+e);d.$container.find('[name]').andSelf('[name]').each(function(){var a=$(this),name=a.attr('name'),parts=name.split(c.name_suffix_splitter),new_name=parts[0]+d._.repeat_suffix;for(var i=c.nesting*2+3;i<parts.length;i++){new_name+=parts[i]}if(name!==new_name){a.attr('name',new_name)}});d.parent().children().sort(function(a,b){if(a._param('repeat_position')<b._param('repeat_position')){b.change();return-1}else{return 1}})},repeat_get_params=function(c,d,e,f){var g={};$.each(e,function(a,b){if((a.indexOf('_')!=0)&&!(b instanceof jQuery)&&!(b instanceof jQuery)&&($.type(b)!=='function'||a==='on')){g[a]=repeat_get_params_value(c,d,b,f)}});return g},repeat_get_params_value=function(a,b,c,d){var e,id,new_id,tainted_new_id;if($.type(c)==='array'){e=[];for(var i=0,ii=c.length,v;i<ii;i++){v=repeat_get_params_value(a,b,c[i],d);if(v!==l){e.push(v)}}}else{if(c instanceof m.controls._item&&c.$element&&c.$element.attr('id')){id=c.$element.attr('id')}else if(c&&c.id){id=c.id}if(id){new_id=id.replace(a.id_suffix_pattern,'')+d;tainted_new_id=m.taint_css(new_id)}if(id&&(b.attr('id')==new_id||b.find('#'+tainted_new_id).length)){e='[id='+tainted_new_id+']'}else if(c instanceof m.repeats.item||c instanceof m.controls._item){e=c}else if($.type(c)==='object'){e=repeat_get_params(a,b,c,d)}else{e=c}}return e},repeat_new_control_count=0;return m})()})(window);